---
name: CI Arm
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    # runs-on: ubuntu-20.04
    permissions:
      # Needed to interact with GitHub's OIDC Token endpoint for AWS
      id-token: write
      contents: read
    env:
      AWS_ROLE_TO_ASSUME: arn:aws:iam::770916339360:role/foo-dev-codebuild-github-action-role
      AWS_REGION: ap-northeast-1
    steps:
      # - name: Dump event
      #   run: cat "$GITHUB_EVENT_PATH"

      # https://github.com/aws-actions/configure-aws-credentials
      # https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # - name: Display AWS identity
      #   run: aws sts get-caller-identity

      # We don't need to check out source, just run codebuild
      # - name: Checkout
      #   uses: actions/checkout@v2

      - name: Run CodeBuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: "foo-app-github-action-arm"
          buildspec-override: ecs/buildspec-earthly.yml
          env-vars-for-codebuild: |
            custom,
            requester,
            event-name
        env:
          custom: my environment variable
          requester: ${{ github.actor }}
          event-name: ${{ github.event_name }}
