# Deploy using distroless image
# https://github.com/GoogleContainerTools/distroless
VERSION --shell-out-anywhere --use-copy-include-patterns --referenced-save-only 0.6

# App versions
ARG ELIXIR_VERSION=1.13.3
# ARG OTP_VERSION=23.3.4
ARG OTP_VERSION=24.2
ARG NODE_VERSION=16.14.1
# ARG NODE_VERSION=lts

ARG AWS_CLI_VERSION=2.0.61

# ARG ELIXIR_DEBIAN_VERSION=buster-20210208
ARG ELIXIR_DEBIAN_VERSION=bullseye-20210902-slim

# ARG DEBIAN_VERSION=buster-slim
ARG DEBIAN_VERSION=bullseye-slim

# Docker registries for base images. If blank, will use docker.io.
# If specified, should have a trailing slash.
# REGISTRY is a private registry, e.g. 123.dkr.ecr.ap-northeast-1.amazonaws.com/
# PUBLIC_REGISTRY is for public base images, e.g. debian or alpine
# Public images may be mirrored into the private registry, e.g. with skopeo
ARG REGISTRY=""
ARG PUBLIC_REGISTRY=$REGISTRY

ARG BUILD_IMAGE_NAME=${PUBLIC_REGISTRY}hexpm/elixir
ARG BUILD_IMAGE_TAG=${ELIXIR_VERSION}-erlang-${OTP_VERSION}-debian-${ELIXIR_DEBIAN_VERSION}


# Deploy base image
# https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md
ARG DEPLOY_IMAGE_NAME=gcr.io/distroless/base-debian11
# ARG DEPLOY_IMAGE_TAG=debug-nonroot
# ARG DEPLOY_IMAGE_TAG=latest
# debug includes busybox
ARG DEPLOY_IMAGE_TAG=debug

ARG INSTALL_IMAGE_NAME=${PUBLIC_REGISTRY}debian
ARG INSTALL_IMAGE_TAG=bullseye-slim

# Additional packages to install
ARG BUILD_EXTRA=""
ARG INSTALL_EXTRA=""
ARG DEPLOY_EXTRA=""

ARG LANG=C.UTF-8

# Make apt-get be quiet
# ARG DEBIAN_FRONTEND=noninteractive
# ARG APT_OPTS="-y -qq --no-install-recommends"

# Set arch in Linux naming convention
ARG TARGETARCH

FROM ${PUBLIC_REGISTRY}busybox
ARG LINUX_ARCH=$(uname -m)

# Create build base image with OS dependencies
build-os-deps:
    FROM ${BUILD_IMAGE_NAME}:${BUILD_IMAGE_TAG}

    # Configure apt caching for use with BuildKit
    # The default Debian Docker image has special config to clear caches.
    # If we are using --mount=type=cache, then we want it.
    # https://github.com/debuerreotype/debuerreotype/blob/master/scripts/debuerreotype-minimizing-config
    RUN set -exu && \
        rm -f /etc/apt/apt.conf.d/docker-clean && \
        echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
        echo 'Acquire::CompressionTypes::Order:: "gz";' > /etc/apt/apt.conf.d/99use-gzip-compression

    RUN --mount=type=cache,id=apt-cache,target=/var/cache/apt,sharing=locked \
        --mount=type=cache,id=apt-lib,target=/var/lib/apt,sharing=locked \
        --mount=type=cache,id=debconf,target=/var/cache/debconf,sharing=locked \
        set -exu && \
        apt-get update -qq && \
        DEBIAN_FRONTEND=noninteractive \
        apt-get -y install -y -qq --no-install-recommends \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            gnupg-agent \
            # software-properties-common \
            build-essential \
            git \
            lsb-release \
            jq \
            $BUILD_EXTRA && \

        # Install node using n
        curl -L https://raw.githubusercontent.com/tj/n/master/bin/n -o /usr/local/bin/n && \
        chmod +x /usr/local/bin/n && \
        # Install lts version
        # n lts && \
        # Install specific version
        n "$NODE_VERSION" && \
        rm /usr/local/bin/n && \

        # Install latest Postgres
        # curl -sL https://www.postgresql.org/media/keys/ACCC4CF8.asc -o /etc/apt/trusted.gpg.d/postgresql-ACCC4CF8.asc && \
        # echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -sc)-pgdg main" | tee /etc/apt/sources.list.d/pgdg.list && \
        # echo "Package: *\nPin: release o=apt.postgresql.org\nPin-Priority: 500\n" | tee /etc/apt/preferences.d/pgdg.pref && \
        # apt-get update -qq && \
        # apt-get -y install $APT_OPTS \
        #     libpq-dev \
        #     postgresql-client &&

        # Install Microsoft ODBC Driver for SQL Server
        # curl -sL https://packages.microsoft.com/keys/microsoft.asc -o /etc/apt/trusted.gpg.d/microsoft.asc && \
        # curl -s https://packages.microsoft.com/config/debian/11/prod.list -o /etc/apt/sources.list.d/mssql-release.list && \
        # export ACCEPT_EULA=Y && \
        # apt-get -qq update -qq && apt-get -y install $APT_OPTS msodbcsql17 && \


        # Remove everything related to a package including the configuration files.
        # Remove packages automatically installed because a package required
        # them but, with the other packages removed, are no longer needed.
        # Use this to remove packages installed temporarily.
        # apt-get purge -y --auto-remove curl && \

        # https://www.networkworld.com/article/3453032/cleaning-up-with-apt-get.html
        # https://manpages.ubuntu.com/manpages/jammy/man8/apt-get.8.html

        # Delete local repository of retrieved package files in /var/cache/apt/archives
        # This is handled automatically by /etc/apt/apt.conf.d/docker-clean
        # Use this if not running --mount=type=cache.
        # apt-get clean && \

        # Delete info on installed packages
        # This saves some space, but it can be useful to have them as a record
        # of what was installed, e.g. for auditing images.
        # rm -rf /var/lib/dpkg && \

        # Delete debconf data files to save some space
        # rm -rf /var/cache/debconf && \

        # Delete index of available files from apt-get update
        # Use this if not running --mount=type=cache.
        # rm -rf /var/lib/apt/lists/*

        # Delete logs of installed packages
        truncate -s 0 /var/log/apt/* && \
        truncate -s 0 /var/log/dpkg.log

    SAVE IMAGE --cache-hint

# Staging image for binaries which are copied into final deploy image
deploy-install:
    FROM ${INSTALL_IMAGE_NAME}:${INSTALL_IMAGE_TAG}

    # Configure apt caching for use with BuildKit
    # The default Debian Docker image has special config to clear caches.
    # If we are using --mount=type=cache, then we want it.
    RUN set -exu && \
        rm -f /etc/apt/apt.conf.d/docker-clean && \
        echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
        echo 'Acquire::CompressionTypes::Order:: "gz";' > /etc/apt/apt.conf.d/99use-gzip-compression

    RUN --mount=type=cache,id=apt-cache,target=/var/cache/apt,sharing=locked \
        --mount=type=cache,id=apt-lib,target=/var/lib/apt,sharing=locked \
        --mount=type=cache,id=debconf,target=/var/cache/debconf,sharing=locked \
        set -exu && \
        apt-get update -qq && \
        DEBIAN_FRONTEND=noninteractive \
        apt-get -y install -y -qq --no-install-recommends \
            # apt-transport-https \
            ca-certificates \
            curl \
            # gnupg-agent \
            # software-properties-common \
            # gnupg \
            unzip \
            busybox-static \
            locales \

            # Needed by Erlang VM
            libtinfo6 \
            $INSTALL_EXTRA && \

        # Generate locales specified in /etc/locale.gen
        locale-gen && \

        # Remove everything related to a package including the configuration files.
        # Remove packages automatically installed because a package required
        # them but, with the other packages removed, are no longer needed.
        # Use this to remove packages installed temporarily.
        # apt-get purge -y --auto-remove curl && \

        # https://www.networkworld.com/article/3453032/cleaning-up-with-apt-get.html
        # https://manpages.ubuntu.com/manpages/jammy/man8/apt-get.8.html

        # Delete local repository of retrieved package files in /var/cache/apt/archives
        # This is handled automatically by /etc/apt/apt.conf.d/docker-clean
        # Use this if not running --mount=type=cache.
        # apt-get clean && \

        # Delete info on installed packages
        # This saves some space, but it can be useful to have them as a record
        # of what was installed, e.g. for auditing images.
        # rm -rf /var/lib/dpkg && \

        # Delete debconf data files to save some space
        # rm -rf /var/cache/debconf && \

        # Delete index of available files from apt-get update
        # Use this if not running --mount=type=cache.
        # rm -rf /var/lib/apt/lists/*

        # Delete logs of installed packages
        truncate -s 0 /var/log/apt/* && \
        truncate -s 0 /var/log/dpkg.log

    # Install AWS CLI v2 from binary package
    # https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
    # https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html
    # RUN set -ex && \
    #     curl -sSfL "https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m)-${AWS_CLI_VERSION}.zip" -o "awscliv2.zip" && \
    #     unzip -q awscliv2.zip && \
    #     ./aws/install && \
    #     rm -rf ./aws && \
    #     rm awscliv2.zip
    # SAVE ARTIFACT /usr/local/aws-cli /aws-cli

    RUN mkdir -p /busybox && cp /bin/busybox /busybox/sh
    SAVE ARTIFACT /busybox /busybox

    SAVE ARTIFACT /usr/lib/locale/C.UTF-8

    SAVE ARTIFACT /lib/${LINUX_ARCH}-linux-gnu/libtinfo.so.6 /libs/
    SAVE ARTIFACT /lib/${LINUX_ARCH}-linux-gnu/libgcc_s.so.1 /libs/
    # SAVE ARTIFACT /usr/lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6 /libs/libstdcpp.so.6
    SAVE ARTIFACT /usr/lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6.0.28 /libs/libstdcpp.so.6.0.28

    SAVE IMAGE --cache-hint

deploy-base:
    FROM ${DEPLOY_IMAGE_NAME}:${DEPLOY_IMAGE_TAG}

    # Default env vars
    # SHLVL=1
    # SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    # PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/busybox

    # This is necessary for RUN commands to work
    COPY +deploy-install/busybox/sh /bin/
    # RUN /bin/sh --install -s /bin
    # RUN set -ex && mkdir -p /bin /sbin /usr/bin /usr/sbin && /bin/sh --install -s
    # RUN set -ex && mkdir -p /bin /sbin /usr/bin /usr/sbin && /busybox/busybox --install -s

    # This doesn't work because Earthly insists on stat'ing /bin/sh before
    # running commands, even when we are specifying a shell
    # RUN ["/busybox/sh", "-c", "\"ln -s /busybox/busybox /bin/sh\""]
    # base+deploy-base *failed* | --> RUN /busybox/sh -c "ln -s /busybox/busybox /bin/sh"
    # base+deploy-base *failed* | container_linux.go:380: starting container process caused: exec: "/bin/sh": stat /bin/sh: no such file or directory

    COPY +deploy-install/C.UTF-8 /usr/lib/locale/C.UTF-8

    ENV LANG=$LANG

    COPY +deploy-install/libs/libtinfo.so.6 /lib/${LINUX_ARCH}-linux-gnu/
    # RUN ln -s /lib/${LINUX_ARCH}-linux-gnu/libtinfo.so.6.2 /lib/${LINUX_ARCH}-linux-gnu/libtinfo.so.6

    COPY +deploy-install/libs/libgcc_s.so.1 /lib/${LINUX_ARCH}-linux-gnu/
    # COPY +deploy-install/libs/libstdcpp.so.6 /usr/lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6
    COPY +deploy-install/libs/libstdcpp.so.6.0.28 /lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6.0.28
    RUN ln -s /lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6.0.28 /usr/lib/${LINUX_ARCH}-linux-gnu/libstdc++.so.6

    # RUN ls -l /usr/lib/${LINUX_ARCH}-linux-gnu/*
    # RUN ls -l /lib/${LINUX_ARCH}-linux-gnu/*

    # COPY +deploy-install/aws-cli /usr/local/aws-cli

    SAVE IMAGE --cache-hint
